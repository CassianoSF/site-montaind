import"../../web_modules/imba/dist/imba.js";function n(a,b){var c=Object.getOwnPropertyDescriptors(b);return Object.defineProperties(a.prototype,c),a}var g=typeof window!=="undefined",p={};class q{}import{Location as h}from"./location.js";import"./history.js";import{Request as k}from"./request.js";import{Route as i}from"./route.js";import"./element.js";var l;export class Router{static get instance(){return l||(l=new this())}constructor(a={}){this.routes={},this.options=a,this.busy=[],this.root=a.root||"",this.history=window.history,this.location=new h(a.url||document.location.href,this),this.mode=a.mode||"history",this.setup(),this.instance||(this.instance=this)}get origin(){return this.$origin||(this.$origin=document.location.origin)}option(a,b){return b==void 0?this.options[a]:(this.options[a]=b,this)}get realpath(){let a=document.location;return a.href.slice(a.origin.length);return this.location.path}get state(){return{}}pushState(a,b,c){return this.history.pushState(a,b||null,String(c))}replaceState(a,b,c){return this.history.replaceState(a,b||null,String(c))}refresh(a={}){var b=this;if(this.refreshing)return;this.refreshing=!0;let c=this.location,d=h.parse(a.location||this.realpath,this),f=a.mode;if(!d.equals(c)){let e=new k(this,d,c);e.mode=f,this.emit("beforechange",e);if(e.aborted){var j=!e.forceAbort&&window.confirm("Are you sure you want to leave? You might have unsaved changes");j?e.aborted=!1:f=="pop"?this.pushState(this.state,null,String(c)):f=="replace"&&this.replaceState(this.state,null,String(c))}e.aborted||(this.location=e.location,f=="push"?this.pushState(a.state||this.state,null,String(this.location)):f=="replace"&&this.replaceState(a.state||this.state,null,String(this.location)),g&&(this.location.state=window.history.state),this.emit("change",e),imba.commit())}return this.onReady(function(){let e=document.location.hash;if(e!=b.$hash)return b.emit("hashchange",b.$hash=e)}),this.refreshing=!1,this}onpopstate(a){return this.refresh({pop:!0,mode:"pop"}),this}onbeforeunload(a){let b=new k(this,null,this.location);return this.emit("beforechange",b),b.aborted?!0:void 0}onhashchange(a){return this.emit("hashchange",this.$hash=document.location.hash),imba.commit()}setup(){return g&&(this.onclick=this.onclick.bind(this),this.onhashchange=this.onhashchange.bind(this),this.$hash=document.location.hash,this.location=h.parse(this.realpath,this),this.history.replaceState(this.state,null,String(this.location)),window.onpopstate=this.onpopstate.bind(this),window.onbeforeunload=this.onbeforeunload.bind(this),window.addEventListener("hashchange",this.onhashchange),window.addEventListener("click",this.onclick,{capture:!0})),this}onclick(a){if(a.metaKey||a.altKey)return;let b=null,c=null,d=a.target;for(;d;)d.nodeName=="A"&&(b||(b=d)),d.$routeTo&&(c||(c=d)),d=d.parentNode;if(b&&c!=b&&(!c||c.contains(b))){let f=b.getAttribute("href");f&&!f.match(/\:\/\//)&&!b.getAttribute("target")&&!b.classList.contains("external")&&b.addEventListener("click",this.onclicklink.bind(this),{once:!0})}return!0}onclicklink(a){let b=a.currentTarget||a.target,c=b.getAttribute("href"),d=new URL(b.href),f=d.href.slice(d.origin.length);return this.go(f),a.stopPropagation(),a.preventDefault()}get path(){return this.location.path}get url(){return this.location.url}query(a,b){return a==void 0?this.location.searchParams():this.location.query(a,b)}get hash(){return this.$hash}serializeParams(a){var b;if(a instanceof Object){b=[];for(let d=0,f=Object.keys(a),j=f.length,e,m;d<j;d++)e=f[d],m=a[e],b.push([e,globalThis.encodeURI(m)].join("="));var c=b;return c.join("&")}return a||""}set hash(a){g&&this.history.replaceState({},null,"#"+this.serializeParams(a))}match(a){var b,c=(b=this.routes)[a]||(b[a]=new i(this,a));return c.test()}route(a){var b;return(b=this.routes)[a]||(b[a]=new i(this,a))}routeFor(a,b,c,d){return new i(this,b,c,d)}go(a,b={}){let c=this.location.clone().update(a,b);return this.refresh({push:!0,mode:"push",location:c,state:b}),this}replace(a,b={}){let c=this.location.clone().update(a,b);return this.refresh({replace:!0,mode:"replace",location:c,state:b})}normalize(a){return this.mode=="hash"?a="#"+a:this.root()&&(a=this.root()+a),a}onReady(a){var b=this;return imba.scheduler.add(function(){return b.busy.length==0?a(b):imba.once(b,"ready",a)})}emit(a,...b){return imba.emit(this,a,b)}on(a,...b){return imba.listen(this,a,...b)}once(a,...b){return imba.once(this,a,...b)}un(a,...b){return imba.unlisten(this,a,...b)}tapRouteHandler(a){let b=this.dom(),c=this.dom().getAttribute("href");b.nodeName!="A"&&(a.meta()||a.alt())&&(a.stop().prevent(),window.open(c,"_blank"));let d=this.trigger("taproute",{path:c,sourceEvent:a,router:this.router});d.isPrevented()||(a.stop().prevent(),a.meta()||a.alt()?window.open(c,"_blank"):this.router.go(c,{}));return}}n(imba.tags.get("element","Element"),{get router(){return Router.instance}});
